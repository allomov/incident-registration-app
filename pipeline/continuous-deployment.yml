---
resources:
- name: git-repository
  type: git
  source:
    uri: https://github.com/allomov/incident-registration-app.git
    branch: master

- name: slack-notification
  type: slack-notification
  source:
    url: {{slack-notification-url}}

jobs:
- name: unit-tests
  plan:
  - get: git-repository
    trigger: true
  - task: unit-tests
    file: git-repository/pipeline/tasks/unit-tests.yml

- name: functional-tests
  plan:
  - get: git-repository
    trigger: true
  - task: functional-tests
    file: git-repository/pipeline/tasks/functional-tests.yml

- name: web-ui-tests
  plan:
  - get: git-repository
    trigger: true
  - task: web-ui-tests
    file: git-repository/pipeline/tasks/web-ui-tests.yml
    on_success:
      do:
      - put: slack-notification
        params:
          channel: {{slack-channel}}
          username: {{slack-username}}
          icon_emoji: ":robot_face:"
          text: "The new version of incident-registration application is out, I am currently running pipeline with tests for it: http://192.168.100.4:8080/pipelines/continuous-deployment"
    on_failure:
      do:
      - put: slack-notification
        params:
          channel: {{slack-channel}}
          username: {{slack-username}}
          icon_emoji: ":robot_face:"
          text: "web-ui-tests failed, you can find tests: http://192.168.100.4:8080/pipelines/continuous-deployment"

- name: deploy-to-staging-cf
  plan:
  - get: git-repository
    passed:
      - unit-tests
      - functional-tests
      - web-ui-tests
    trigger: true
  - put: slack-notification
    params:
      channel: {{slack-channel}}
      username: {{slack-username}}
      icon_emoji: ":robot_face:"
      text: "All tests passed successfully on staging environment: http://staging-incident-registration.pcf-den.altoros.com"

  - task: deploy-to-stagging-cf
    file: git-repository/pipeline/tasks/deploy-to-staging.yml
    config:
      params:
        cf_api: {{cf-api}}
        cf_username: {{cf-username}}
        cf_password: {{cf-password}}
        cf_org: {{cf-org}}
        cf_space: "staging"
        app_name: "staging-incident-registration"
        app_folder: "git-repository"

  - put: slack-notification
    params:
      channel: {{slack-channel}}
      username: {{slack-username}}
      icon_emoji: ":robot_face:"
      text: "Application is successfully deployed to staging environment: http://staging-incident-registration.pcf-den.altoros.com"

- name: acceptance-tests
  plan:
  - get: git-repository
    passed: ["deploy-to-staging-cf"]
    trigger: true
  - task: acceptance-tests
    file: git-repository/pipeline/tasks/acceptance-tests.yml
    on_failure:
      do:
      - put: slack-notification
        params:
          channel: {{slack-channel}}
          username: {{slack-username}}
          icon_emoji: ":robot_face:"
          text: "Acceptance tests failed :face_with_head_bandage: Check the logs http://192.168.100.4:8080/pipelines/continuous-deployment/jobs/acceptance-tests or check app logs with this command: `cf logs staging-incident-registration-green-version --recent`"
    on_success:
      do:
      - put: slack-notification
        params:
          channel: {{slack-channel}}
          username: {{slack-username}}
          icon_emoji: ":robot_face:"
          text: "Acceptance tests passed :smiley: Starting deployment to production http://192.168.100.4:8080/pipelines/continuous-deployment/jobs/blue-green-deployment-to-production-cf"

- name: blue-green-deployment-to-production-cf
  plan:
  - get: git-repository
    passed: ["acceptance-tests"]
    trigger: true
  - task: blue-green-deployment-to-production-cf
    file: git-repository/pipeline/tasks/deploy-to-production.yml
    config:
      params:
        cf_api: {{cf-api}}
        cf_username: {{cf-username}}
        cf_password: {{cf-password}}
        cf_org: {{cf-org}}
        cf_space: "production"
        app_name: "incident-registration"
        app_folder: "git-repository"
  - put: slack-notification
    params:
      channel: {{slack-channel}}
      username: {{slack-username}}
      icon_emoji: ":robot_face:"
      text: "Application is updated successfully: http://incident-registration.pcf-den.altoros.com"
