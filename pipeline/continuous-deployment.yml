---
resources:
- name: github-repository
  type: git
  source:
    uri: https://github.com/allomov/incident-registration-app.git
    branch: master

- name: slack-notification
  type: slack-notification
  source:
    url: {{slack-notification-url}}

jobs:
- name: unit-tests
  plan:
  - get: github-repository
    trigger: true
  - task: unit-tests
    file: github-repository/pipeline/tasks/unit-tests.yml
  - put: slack-notification
    params:
      channel: {{slack-channel}}
      username: {{slack-username}}
      icon_url: {{slack-icon-url}}
      text: Unit tests прошли успешно
        

- name: functional-tests
  plan:
  - get: github-repository
    trigger: true
  - task: functional-tests
    file: github-repository/pipeline/tasks/functional-tests.yml
  - put: slack-notification
    params:
      channel: {{slack-channel}}
      username: {{slack-username}}
      icon_url: {{slack-icon-url}}
      text: Functional tests прошли успешно

- name: deploy-to-staging-cf
  plan:
  - get: github-repository
    passed:
      - unit-tests
      - functional-tests
    trigger: true
  - task: deploy-to-stagging-cf
    file: github-repository/pipeline/tasks/deploy-to-staging.yml
    config:
      params:
        cf_api: {{cf-api}}
        cf_username: {{cf-username}}
        cf_password: {{cf-password}}
        cf_org: {{cf-org}}
        cf_space: "staging"
        app_name: "staging-incident-registration"
        app_folder: "github-repository"
  - put: slack-notification
    params:
      channel: {{slack-channel}}
      username: {{slack-username}}
      icon_url: {{slack-icon-url}}
      text: |
        Приложение успешно задеплоено на staging: http://staging-incident-registration.pcf.altoros.com

- name: acceptance-tests
  plan:
  - get: github-repository
    passed: ["deploy-to-staging-cf"]
    trigger: true
  - task: acceptance-tests
    file: github-repository/pipeline/tasks/acceptance-tests.yml
- name: blue-green-deployment-to-production-cf
  plan:
  - get: github-repository
    passed: ["acceptance-tests"]
    trigger: true
  - task: blue-green-deployment-to-production-cf
    file: github-repository/pipeline/tasks/deploy-to-production.yml
    config:
      params:
        cf_api: {{cf-api}}
        cf_username: {{cf-username}}
        cf_password: {{cf-password}}
        cf_org: {{cf-org}}
        cf_space: "production"
        app_name: "incident-registration"
        app_folder: "github-repository"
